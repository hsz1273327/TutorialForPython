
# `*`ç±»åž‹æ³¨é‡Šå’Œæ£€éªŒ

python3.5èµ·å°±æ”¯æŒå‡½æ•°çš„ç±»åž‹æ³¨é‡Š(pep 484),å®ƒçš„ç»“æž„å¦‚ä¸‹:


```python
def func(arg:int)->int:
    pass
```

***ps:ç±»åž‹æ³¨é‡Šåªæ˜¯æ³¨é‡Š,pythonè§£é‡Šå™¨å¹¶ä¸ä¼šå¤„ç†å®ƒ,è¦è®©å®ƒæœ‰ç±»åž‹æ£€éªŒçš„åŠŸèƒ½è¿˜è¦æœ‰å…¶ä»–å·¥å…·é…åˆ.***

å‡½æ•°çš„å‚æ•°ç±»åž‹ä¿å­˜åœ¨å®ƒçš„`__annotations__`å±žæ€§ä¸Š


```python
func.__annotations__
```




    {'arg': int, 'return': int}



## `*`è‡ªå®šä¹‰æ³›åž‹æ³¨è§£


ç±»åž‹æ³¨é‡Šå¯ä»¥ç›´æŽ¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ç±»å’Œè‡ªå·±å®šä¹‰çš„ç±»,ä½†å¯¹äºŽæ³›åž‹æ³¨è§£å°±åŠ›ä¸ä»Žå¿ƒäº†,å¯¹äºŽè¿™ç§éœ€æ±‚,pythonå†…ç½®äº†typingæ¨¡å—æ¥å¸®åŠ©æ³›åž‹æ³¨é‡Š

### åç¨‹æ³¨é‡Š


```python
async def spam(ignored: int) -> str:
    return 'spam'

async def foo() -> None:
    bar = await spam(42)  # type: str
```

### ç±»åž‹åˆ«å


```python
Url = str
def retry(url: Url, retry_count: int) -> None:
    pass
```

### å¯è°ƒç”¨ç±»åž‹


```python
from typing import Callable

def feeder(get_next_item: Callable[[], str]) -> None:
    pass

def async_query(on_success: Callable[[int], None],
                on_error: Callable[[int, Exception], None]) -> None:
    pass
```

### ç”Ÿæˆå™¨ç±»åž‹


```python
from typing import Generator
def echo_round() -> Generator[int, float, str]:
    res = yield
    while res:
        res = yield round(res)
    return 'OK'
```


```python
from typing import Mapping, Set

def notify_by_email(employees: Set[int], overrides: Mapping[str, str]) -> None:
    pass
```

### æ³›åž‹


```python
from typing import Sequence, TypeVar

T = TypeVar('T')      # Declare type variable

def first(l: Sequence[T]) -> T:   # Generic function
    return l[0]
```

### å—é™æ³›åž‹


```python
from typing import TypeVar

AnyStr = TypeVar('AnyStr', str, bytes)#å¿…é¡»æ˜¯stræˆ–è€…bytes

def concat(x: AnyStr, y: AnyStr) -> AnyStr:
    return x + y
```

###  Unionç±»åž‹

Unionç±»åž‹å¸¸ç”¨äºŽå¯é€‰ç±»åž‹



```python
from typing import Union
def handle_employees(e: Union[int, Sequence[int]]) -> None:
    if isinstance(e, Employee):
        e = [e]
```

### Optionalç±»åž‹

Optionalç±»åž‹é€šå¸¸è¡¨ç¤ºè¿™ä¸ªè¢«æ³¨é‡Šçš„å‚æ•°æ˜¯å¯ä»¥ä¸ºNoneçš„.


```python
from typing import Optional
def option_demo(x:int,y: Optional[int]=None) -> int:
    if y:
        return x+y
    else:
        return x
```

### ç”¨æˆ·è‡ªå®šä¹‰æ³›åž‹


```python
from typing import TypeVar, Generic
from typing import Iterable
class Logger:
    pass

T = TypeVar('T')

class LoggedVar(Generic[T]):
    def __init__(self, value: T, name: str, logger: Logger) -> None:
        self.name = name
        self.logger = logger
        self.value = value

    def set(self, new: T) -> None:
        self.log('Set ' + repr(self.value))
        self.value = new

    def get(self) -> T:
        self.log('Get ' + repr(self.value))
        return self.value

    def log(self, message: str) -> None:
        self.logger.info('{}: {}'.format(self.name,message))
        


def zero_all_vars(vars: Iterable[LoggedVar[int]]) -> None:
    for var in vars:
        var.set(0)
```

### anyç±»åž‹

anyç±»åž‹å’Œtsä¸­ä¸€æ ·,ä»£è¡¨ä»»æ„ç±»åž‹éƒ½å¯ä»¥

### æ–¹æ³•é‡è½½


```python
from typing import overload

class bytes:
    @overload
    def __getitem__(self, i: int) -> int: ...
    @overload
    def __getitem__(self, s: slice) -> bytes: ...
```

### å˜é‡æ³¨è§£[3.6]

3.6ç‰ˆæœ¬èµ·å˜é‡ç±»åž‹ä¹Ÿå¯ä»¥æ³¨é‡Šäº†(pep 526),è¿™çœ‹èµ·æ¥å°±åƒcè¯­è¨€ä¸€æ ·,ç„¶è€Œå®ƒä¾ç„¶è¿˜æ˜¯æ³¨é‡Š


```python
from typing import Optional,List
foo: Optional[int]
bar: List[str] = []
```


```python
from typing import ClassVar

class C:
    x: int  # instance variable
    y: ClassVar[int]  # class variable
    z = None  # type: ClassVar[int]

    def foo(self) -> None:
        self.x = 0  # OK
        self.y = 0  # Error: Cannot assign to class variable "y" via instance

C.y = 0  # This is OK
```

æ¨¡å—,ç±»ä¸­çš„çš„å˜é‡æ³¨è§£åŒæ ·ä¿å­˜åœ¨`__annotations__`ä¸­


```python
C.__annotations__
```




    {'x': int, 'y': typing.ClassVar[int]}




```python
c = C()
```


```python
c.__annotations__
```




    {'x': int, 'y': typing.ClassVar[int]}




```python
__annotations__
```




    {'bar': typing.List[str], 'foo': typing.Union[int, NoneType]}



## é™æ€ç±»åž‹æ£€éªŒ

pythonè§£é‡Šå™¨å¹¶ä¸ä¼šåšé™æ€ç±»åž‹æ£€éªŒ,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨[mypy](http://mypy-lang.org/)æ¥å®žçŽ°


```python
%%writefile src/C2/mypytest.py

from typing import Callable

def twice(i: int, next: Callable[[int], int]) -> int:
    return next(next(i))

def add(i: int) -> str:#å†™æˆè¿”å›žstr,è¿™æ ·å°±ä¼šæŠ¥é”™!
    return i + 1

print(twice(3, add))   # 5
```

    Overwriting src/C2/mypytest.py



```python
!mypy src/C2/mypytest.py
```

    src/C2/mypytest.py:8: error: Incompatible return value type (got "int", expected "str")
    src/C2/mypytest.py:10: error: Argument 2 to "twice" has incompatible type "Callable[[int], str]"; expected "Callable[[int], int]"


## `*`è¿è¡Œæ—¶ç±»åž‹æ£€æµ‹

æ ‡å‡†åº“è‡ªå¸¦çš„typingåªèƒ½ç”¨äºŽé™æ€æ£€æµ‹,å½“æˆ‘ä»¬éœ€è¦è¿è¡Œæ—¶æ£€æµ‹æ—¶å¯ä»¥å€ŸåŠ©[enforce](https://github.com/RussBaz/enforce)æ¥å®žçŽ°.enforceä½¿ç”¨è£…é¥°å™¨è¯­æ³•,
å®ƒæä¾›äº†è£…é¥°å™¨ `@runtime_validation` ç”¨äºŽè¿è¡Œæ—¶è¿›è¡Œç±»åž‹æ£€æµ‹.åŒæ—¶æä¾›äº†å·¥å…·`is_type_of_type`æ¥å¯¹ç±»åž‹å’Œç”³æ˜Žç±»åž‹è¿›è¡Œæ¯”è¾ƒ.


éœ€è¦æ³¨æ„çš„æ˜¯`is_type_of_type`å¯¹é€šè¿‡cloudpickleçš„å¯¹è±¡æ— æ•ˆ


```python
!pip install enforce
```

    Looking in indexes: http://pypi.douban.com/simple
    Requirement already satisfied: enforce in /Users/huangsizhe/anaconda3/lib/python3.6/site-packages (0.3.4)
    Requirement already satisfied: wrapt in /Users/huangsizhe/anaconda3/lib/python3.6/site-packages (from enforce) (1.10.11)
    [31mccxt 1.13.123 has requirement certifi>=2018.1.18, but you'll have certifi 2016.2.28 which is incompatible.[0m
    [31mccxt 1.13.123 has requirement requests>=2.18.4, but you'll have requests 2.14.2 which is incompatible.[0m



```python
import enforce

@enforce.runtime_validation 
class A:
    test:str
    def __init__(self,text:str)->None:
        self.text = text
        
@enforce.runtime_validation
def foo(text: str) -> A:
    return A(text)
```


```python
a = foo("asd")
```


```python
b = foo(123)
```


    ---------------------------------------------------------------------------

    RuntimeTypeError                          Traceback (most recent call last)

    <ipython-input-25-a3104ecab128> in <module>()
    ----> 1 b = foo(123)
    

    ~/anaconda3/lib/python3.6/site-packages/enforce/decorators.py in universal(wrapped, instance, args, kwargs)
        102 
        103             # First, check argument types (every key not labelled 'return')
    --> 104             _args, _kwargs, _ = enforcer.validate_inputs(parameters)
        105 
        106             if instance_method:


    ~/anaconda3/lib/python3.6/site-packages/enforce/enforcers.py in validate_inputs(self, input_data)
         84 
         85         exception_text = parse_errors(self.validator.errors, self.hints)
    ---> 86         raise RuntimeTypeError(exception_text)
         87 
         88     def validate_outputs(self, output_data: T) -> T:


    RuntimeTypeError: 
      The following runtime type errors were encountered:
           Argument 'text' was not of type <class 'str'>. Actual type was int.

