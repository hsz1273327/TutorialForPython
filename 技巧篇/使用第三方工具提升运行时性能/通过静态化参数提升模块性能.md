# é€šè¿‡é™æ€åŒ–å‚æ•°æå‡æ¨¡å—æ€§èƒ½

pythonæ˜¯è„šæœ¬è¯­è¨€,pythonçš„æ¨¡å—å¯ä»¥æ˜¯pythonè„šæœ¬ä¹Ÿå¯ä»¥æ˜¯ç¬¦åˆPythonè§„èŒƒçš„åŠ¨æ€é“¾æ¥åº“.åˆ©ç”¨è¿™ä¸€ç‰¹æ€§pythoné€šå¸¸è¢«ä½œä¸ºèƒ¶æ°´è¯­è¨€ä½¿ç”¨--pythonä½œä¸ºäº¤äº’ç«¯,å®é™…çš„ä»…è°ƒç”¨ç”±å…¶ä»–æ›´åŠ é«˜æ•ˆçš„è¯­è¨€å†™å¥½ç¼–è¯‘æˆçš„åŠ¨æ€é“¾æ¥åº“.è¿™ç§æ–¹å¼å¹¶ä¸æ˜¯æœ¬æ–‡å…³æ³¨çš„å†…å®¹,ä½†ç”±æ­¤å¼•å…¥ä¸€ç§æ€è·¯--æœ‰æ²¡æœ‰è¿™æ ·ä¸€ä¸ªå·¥å…·å¯ä»¥å°†pythonè„šæœ¬ç¼–è¯‘ä¸ºåŠŸèƒ½ç›¸åŒ,æ€§èƒ½ä¸Šå…¨é¢ä¼˜åŒ–è¿‡çš„åŠ¨æ€é“¾æ¥åº“,é‚£ä¹ˆæˆ‘ä»¬ä¸å°±å¯ä»¥è°ƒç”¨è¿™ä¸ªåŠ¨æ€é“¾æ¥åº“è€Œä¸æ˜¯æºç çš„è„šæœ¬ä»è€Œæé«˜ä»£ç çš„è¿è¡Œæ•ˆç‡äº†.

é‚£æœ‰æ²¡æœ‰å‘¢?çœŸçš„æœ‰,è€Œä¸”ä¸æ­¢ä¸€ç§

+ [Cython](https://github.com/cython/cython),è€ç‰Œé¡¹ç›®,åŠŸèƒ½å¼ºå¤§,ä¸“æ³¨äºæ¡¥æ¥pythonå’ŒC,ä¸Šé¢çš„åŠŸèƒ½ä»…æ˜¯å®ƒèƒ½åŠ›çš„ä¸€å°éƒ¨åˆ†.
+ [mypyc](https://mypyc.readthedocs.io/en/latest/index.html),ç”±mypyé¡¹ç›®æ‰©å±•è€Œæ¥.

Cythonå¤ªè¿‡å¤æ‚,éœ€è¦ç³»ç»Ÿçš„å­¦ä¹ ,å› æ­¤åé¢ä¼šæœ‰ä¸“é—¨çš„æ–‡ç« ä»‹ç»,æœ¬æ–‡å°†ä¸“æ³¨äº`mypyc`æŠ€æœ¯æ–¹æ¡ˆ

## ä½¿ç”¨mypycé™æ€åŒ–pythonæ¨¡å—

mypycåœ¨è¯­è¨€å±‚é¢å’Œæœ¬æ–‡ä¸­[é™æ€ç±»å‹æ£€æµ‹éƒ¨åˆ†](https://blog.hszofficial.site/TutorialForPython/#/%E5%B7%A5%E5%85%B7%E9%93%BE%E7%AF%87/%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%B5%8B)ä¸­ä»‹ç»çš„å®Œå…¨å…¼å®¹,ä»…å¢åŠ äº†`int`ç±»å‹çš„ç»†åŒ–ç±»å‹`mypy_extensions.i64`,`mypy_extensions.i32`,`mypy_extensions.i16`,`mypy_extensions.u8`è€Œå·²(å½“ç„¶ä¹Ÿå¯ä»¥ä¸ç”¨ä»–ä»¬è¿˜æ˜¯ç›´æ¥ç”¨`int`).æ­£å¸¸å¸¦typehintsçš„pythonä»£ç å¯ä»¥å¹³æ»‘çš„ç›´æ¥ä½¿ç”¨mypycè¿›è¡Œé™æ€åŒ–.


## ä½¿ç”¨é™åˆ¶

mypycä¸€æ ·æœ‰ä½¿ç”¨é™åˆ¶,å¤§è‡´å¯ä»¥å½’ç»“ä¸ºå¦‚ä¸‹å‡ ç‚¹:

+ ä¸èƒ½ä½¿ç”¨ç±»å‹æ ‡æ³¨`Any`,`Any`å¹¶æ²¡æœ‰é™åˆ¶ç±»å‹,è‡ªç„¶æ— æ³•é™æ€åŒ–
+ ç¼–è¯‘è¦æ±‚ç±»å‹ä¸¥æ ¼åŒ¹é…,ä¹Ÿä¸èƒ½ä½¿ç”¨`# type: ignore`å–æ¶ˆå±€éƒ¨æ³¨é‡Š.ç¼–è¯‘è¿‡åçš„æ¨¡å—ä¹Ÿåªèƒ½ä¸¥æ ¼çš„æŒ‰æ ‡æ³¨çš„ç±»å‹æ‰§è¡Œ,å¦åˆ™ä¼šæŠ›å‡º`TypeError`.
+ ç¼–è¯‘å‡ºæ¥çš„æ¨¡å—æ— æ³•ä½¿ç”¨`python3 <module>.py`æˆ–`python3 -m <module>`æ–¹å¼è¿è¡Œ,åªèƒ½ä½¿ç”¨`python3 -c "import <module>"`æ–¹å¼è¿è¡Œ.åŒæ—¶æºç ä¸­çš„`if __name__ == "__main__": ...`ä¹Ÿä¸ä¼šç”Ÿæ•ˆ
+ çŒ´å­è¡¥ä¸`Monkey patching`ä¸ä¼šç”Ÿæ•ˆ
+ ä¸æ”¯æŒåœ¨æ¡ä»¶åˆ†æ”¯ä¸­çš„å‡½æ•°æˆ–ç±»å®šä¹‰
+ ä¸æ”¯æŒç”Ÿæˆå™¨è¡¨è¾¾å¼
+ ç¼–è¯‘åçš„å¯¹è±¡å°†ä¸å†æ”¯æŒè‡ªçœ
+ ç¼–è¯‘åçš„å¯¹è±¡å°†ä¸å†æ”¯æŒæ‰“æ–­ç‚¹debug,ä»¥åŠ`profile`,`cProfile`, `trace`è¿™äº›ç”¨äºè¿½è¸ªæ€§èƒ½çš„å·¥å…·

è€Œç»è¿‡ç¼–è¯‘çš„ç±»,mypycä¼šå°†å…¶å¤„ç†ä¸ºåŸç”Ÿç±»,é™æ€ç±»åˆä¼šæœ‰ä¸€äº›é¢å¤–é™åˆ¶:

+ ä¸æ”¯æŒ`__del__`,`__index__`,`__getattr__`,`__getattribute__`,`__setattr__`,`__delattr__`
+ ä¸æ”¯æŒåµŒå¥—ç±»
+ å…ƒç±»ä»…æ”¯æŒ`abc.ABCMeta`å’Œ`typing.GenericMeta`
+ ç±»è£…é¥°å™¨ä»…æ”¯æŒ`@mypy_extensions.trait`,`mypy_extensions.mypyc_attr`,`@dataclasses.dataclass`å’Œ`@attr.s(auto_attribs=True)`
+ ç±»ä¸­çš„æ–¹æ³•ä¸æ”¯æŒé™¤äº†`@property`,`@static_method`å’Œ`@class_method`å¤–çš„è£…é¥°å™¨
+ æ— æ³•åŠ¨æ€ç»‘å®šå±æ€§å’Œæ–¹æ³•,åŸç”Ÿç±»ä¸­å­—æ®µå°†å˜ä¸ºä¸å¯å˜,åŒæ—¶ä¹Ÿæ²¡æœ‰`__dict__`å±æ€§,å¦‚æœè¦åˆ é™¤ç±»å±æ€§éœ€è¦åœ¨å®šä¹‰ç±»æ—¶ä½¿ç”¨`__deletable__ = ['x', 'y']`æ ‡æ˜
+ åªæ”¯æŒå•ç»§æ‰¿æˆ–ä¸€ä¸ªåŸºç±»åŠ è‹¥å¹²`@mypy_extensions.trait`è£…é¥°çš„ç‰¹è´¨ç±»


## ç¬¬ä¸€ä¸ªä¾‹å­

æˆ‘ä»¬ä»¥ä¾‹å­`fib.py`å¼€å§‹å®æˆ˜éƒ¨åˆ†

+ `fib.py`

```python
import time


def fib(n: int) -> int:
    if n <= 1:
        return n
    else:
        return fib(n - 2) + fib(n - 1)


t0 = time.time()
fib(32)
print(time.time() - t0)
```

æˆ‘ä»¬çš„ç¼–è¯‘åº”è¯¥éµå¾ªå¦‚ä¸‹é¡ºåºæ­¥éª¤:

1. è¦ç¼–è¯‘æˆ‘ä»¬é¦–å…ˆéœ€è¦ç¡®ä¿å®ƒçš„é™æ€ç±»å‹æ£€æµ‹æ²¡æœ‰é—®é¢˜


```python
!mypy fib.py
```

    [1m[32mSuccess: no issues found in 1 source file[m


2. ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·`mypyc`ç¼–è¯‘æ¨¡å—,`mypyc`æ˜¯`mypy`å®‰è£…çš„ä¸€ä¸ªå¯é€‰é¡¹,å¯ä»¥ç”¨`pip install -U 'mypy[mypyc]'`å®‰è£…


```python
!mypyc fib.py
```

    running build_ext
    building 'fib' extension
    creating build/temp.macosx-10.9-x86_64-cpython-310
    creating build/temp.macosx-10.9-x86_64-cpython-310/build
    /usr/local/Cellar/gcc/13.1.0/bin/gcc-13 -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -fwrapv -O2 -Wall -fPIC -O2 -isystem /Users/mac/micromamba/envs/py3.10/include -fPIC -O2 -isystem /Users/mac/micromamba/envs/py3.10/include -I/Users/mac/micromamba/envs/py3.10/lib/python3.10/site-packages/mypyc/lib-rt -I/Users/mac/micromamba/envs/py3.10/include/python3.10 -c build/__native.c -o build/temp.macosx-10.9-x86_64-cpython-310/build/__native.o -O3 -g1 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable -Wno-ignored-optimization-argument -Wno-cpp
    creating build/lib.macosx-10.9-x86_64-cpython-310
    /usr/local/Cellar/gcc/13.1.0/bin/gcc-13 -bundle -undefined dynamic_lookup -Wl,-rpath,/Users/mac/micromamba/envs/py3.10/lib -L/Users/mac/micromamba/envs/py3.10/lib -Wl,-rpath,/Users/mac/micromamba/envs/py3.10/lib -L/Users/mac/micromamba/envs/py3.10/lib build/temp.macosx-10.9-x86_64-cpython-310/build/__native.o -o build/lib.macosx-10.9-x86_64-cpython-310/fib.cpython-310-darwin.so
    copying build/lib.macosx-10.9-x86_64-cpython-310/fib.cpython-310-darwin.so -> 


3. æµ‹è¯•æˆ‘ä»¬çš„ç¼–è¯‘æ•ˆæœ


```python
!python3 fib.py
```

    0.6489529609680176



```python
!python3 -c "import fib"
```

    0.04175305366516113


å¯ä»¥çœ‹åˆ°æ•ˆæœæ‹”ç¾¤

## æ¨¡å—åŒ…ç¼–è¯‘

è¿™ä¸ªä¾‹å­åœ¨[è¿™é‡Œ]()åŒ…ç¼–è¯‘å¯ä»¥åœ¨å¢åŠ å‚æ•°`-p`,å®ƒä¼šç¼–è¯‘æŒ‡å®šåŒ…ä¸­çš„æ‰€æœ‰å­æ¨¡å—ä¸­çš„æ‰€æœ‰`.py`æ–‡ä»¶,åŒ…æ‹¬`__init__.py`:

```bash
mypyc -p mymath
```

ç¼–è¯‘åŒ…ä¸ªäººå»ºè®®åŒ…çš„é¡¶å±‚`__init__.py`ä¸­å¯¼å…¥æ‰€æœ‰è¦æš´éœ²çš„æ¥å£,é¿å…æš´éœ²å†…éƒ¨æ¨¡å—ç»“æ„


å¦‚æœä½ å¸Œæœ›ä½ çš„åŒ…åœ¨æœ‰æ¡ä»¶çš„æƒ…å†µä¸‹å¯ä»¥è¢«ç¼–è¯‘,æ²¡æ¡ä»¶çš„æƒ…å†µä¸‹ä¸ç¼–è¯‘ä¹Ÿå¯ä»¥æ‰§è¡Œ,å¯ä»¥è¿™æ ·å†™`setup.py`ç›¸å…³çš„æ–‡ä»¶:

+ `pyproject.toml`

    ```toml
    [build-system]
    requires = ["setuptools>=61.0.0", "wheel"]
    build-backend = "setuptools.build_meta"

    [project]
    name = "mymath"
    authors = [
      {name = "hsz", email = "hsz1273327@mail.com"},
    ]
    classifiers = [
      "License :: OSI Approved :: MIT License",
      "Programming Language :: Python :: 3",
      "Programming Language :: Python :: 3.10",
      "Programming Language :: Python :: 3.11",
    ]
    description = "A sample Python project for test."
    keywords = ["math", "test"]
    license = {file = "LICENSE"}
    dynamic = ["version", "readme", "dependencies"]
    requires-python = ">=3.10"

    [project.urls]
    changelog = "https://github.com/me/spam/blob/master/CHANGELOG.md"
    documentation = "https://readthedocs.org"
    homepage = "https://example.com"
    repository = "https://github.com/me/spam.git"

    [tool.setuptools]
    platforms = ["all"]

    [tool.setuptools.dynamic]
    readme = {file = ["README.md"], content-type = "text/markdown"}
    version = {attr = "mymath.version.__version__"}

    [tool.setuptools.packages.find]
    exclude = ['contrib', 'docs', 'test']
    ```

+ `setup.py`

    ```python
    from setuptools import setup


    try:
        from mypyc.build import mypycify
    except Exception as e:
        print("æ²¡æœ‰ mypyc, model install as a pure python model")
        setup()
    else:
        from mypyc.build import mypycify
        print("æœ‰ mypyc, model install as a dll model")
        setup(
            packages=['mymath'],
            ext_modules=mypycify([
                'mymath/__init__.py',
                'mymath/fib.py',
                'mymath/square_op/quadratic_sum.py',
                'mymath/square_op/square_error.py',
                'mymath/square_op/square_root.py',
                'mymath/square_op/square.py',
            ]),
        )

    ```
    
æˆ‘ä»¬æ²¡æœ‰å°†`mypy[mypyc]`æ”¾å…¥`build-system.requires`,è€Œæ˜¯ä¼šæ ¹æ®æ˜¯å¦èƒ½å¯¼å…¥`mypyc.build.mypycify`æ¥å†³å®šbuildè¡Œä¸ºæ˜¯å¦è¦ç”¨mypycè¿›è¡Œç¼–è¯‘.å› æ­¤å¦‚æœè¦åˆ†å‘åˆ°åŒ…ç´¢å¼•ä»“åº“,æˆ‘ä»¬åº”è¯¥æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤:

1. æ‰“æºç åŒ…å¹¶ä¸Šä¼ :

    ```bash
    python -m build --sdist 
    twine upload  dist/*
    ```
    
2. åœ¨ä¸åŒå¹³å°,ä¸åŒæŒ‡ä»¤é›†,ä¸åŒpythonç‰ˆæœ¬ä¸‹åœ¨æ‰“åŒ…ç¯å¢ƒä¸­å®‰è£…å¥½mypycå¹¶ä¸ä½¿ç”¨ä¸´æ—¶è™šæ‹Ÿç¯å¢ƒæ‰“äºŒè¿›åˆ¶åŒ…å¹¶ä¸Šä¼ :

    ```bash
    python -m venv env
    source env/bin/activate
    python -m pip install 'mypy[mypyc]'
    python -m pip install 'setuptools>=61.0.0'
    python -m pip install 'wheel'
    python -m build --wheel -n # æˆ–è€…python -m pip wheel --no-build-isolation
    twine upload  dist/*
    ```
    
ä¸€èˆ¬æˆ‘ä»¬å¼€å‘åªæœ‰ä¸€å°æœºå™¨,è¦å¤špythonç‰ˆæœ¬å¤šå¹³å°å¤šæŒ‡ä»¤é›†éƒ½ç¼–è¯‘ä¸€éç¡®å®æœ‰ç‚¹éš¾ä¸ºäºº,ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„buildè¿‡ç¨‹,å¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ:

1. ä½¿ç”¨åŒ…å«å¤šå¹³å°æ”¯æŒçš„ci/cdå·¥å…·,æ¯”å¦‚`github action`
2. ä½¿ç”¨å·¥å…·[cibuildwheel](https://cibuildwheel.readthedocs.io/),cibuildwheelæ˜¯ä¸€ä¸ªä¸“ä¸ºæ‰“åŒ…wheelè®¾è®¡çš„å·¥å…·,å¯ä»¥é’ˆå¯¹ä¸åŒå¹³å°ä¸åŒæŒ‡ä»¤é›†æ‰“åŒ…æ”¯æŒçš„å¤§éƒ¨åˆ†pythonç‰ˆæœ¬çš„wheelåŒ….

ä»¥`github action`é…ç½®ä¸ºä¾‹,æˆ‘ä»¬å¯ä»¥å†™æˆè¿™æ ·

+ `pyproject.toml`

    ```toml
    ...
    [tool.cibuildwheel]
    # ä½¿ç”¨`build --wheel -n`å‘½ä»¤æ¥æ‰“åŒ…whee
    build-frontend = { name = "build", args = ["-n"] }
    before-build = "pip install build mypy[mypyc]"
    
    [tool.cibuildwheel.macos]
    archs = ["x86_64", "arm64"]

    # On an Linux Intel runner with qemu installed, build Intel and ARM wheels
    [tool.cibuildwheel.linux]
    archs = ["x86_64", "aarch64"]

    [tool.cibuildwheel.windows]
    archs = ["x86_64"]
    ```

+ `.github/workflows/build_and_publish.yml`

    ```yaml
    name: Build_And_Publish

    on:
      release:
        types: [created]

    jobs:
      build_source:
        name: Build Source on linux
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: '3.x'
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install setuptools wheel twine build
        - name: Build and publish
          run: |
            python -m build --sdist
        - name: 'Upload dist'
          uses: 'actions/upload-artifact@v2'
          with:
            name: packages
            path: dist/*
        - name: Publish
          env:
            TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
            TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
          run:
            twine upload dist/*

      build_wheels:
        name: Build wheels on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
          matrix:
            os: [ubuntu-20.04, windows-2019, macos-11]

        steps:
          - uses: actions/checkout@v4

          - name: Build wheels
            uses: pypa/cibuildwheel@v2.16.2
            # env:
            #   CIBW_SOME_OPTION: value
            #    ...
            # with:
            #   package-dir: .
            #   output-dir: wheelhouse
            #   config-file: "{package}/pyproject.toml"

          - uses: actions/upload-artifact@v3
            with:
              path: ./wheelhouse/*.whl

          - name: Install dependencies
            run: |
              pip install twine

          - name: Publish
            env:
              TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
              TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
            run:
              twine upload ./wheelhouse/*

    ```

è¿™æ ·æ¯å½“ä½ åœ¨githubä¸Šåˆ›å»ºreleaseæ—¶å°±ä¼šè‡ªåŠ¨è§¦å‘æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªæ­¥éª¤.`cibuildwheel`ä¼šåœ¨å„è‡ªçš„ç³»ç»Ÿé‡æ‰§è¡Œå„è‡ªå¹³å°çš„æ‰“åŒ…æ“ä½œ,pythonç‰ˆæœ¬ä¹Ÿä¼šæ ¹æ®`pyproject.toml`ä¸­çš„`project.requires-python`å­—æ®µä¸­å®šä¹‰çš„ç‰ˆæœ¬é™åˆ¶æŸ¥æ‰¾å®ƒæ”¯æŒçš„pythonç‰ˆæœ¬è¿›è¡Œç¼–è¯‘.
